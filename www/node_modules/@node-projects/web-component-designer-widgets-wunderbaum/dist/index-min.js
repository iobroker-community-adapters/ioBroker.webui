import{BaseCustomWebComponentConstructorAppend as T,TypedEvent as A,css as k,cssFromString as R,html as N}from"@node-projects/base-custom-webcomponent";import{dragDropFormatNameBindingObject as z}from"@node-projects/web-component-designer";import{Wunderbaum as H}from"wunderbaum";import{css as D}from"@node-projects/base-custom-webcomponent";var x=new URL(import.meta.url),a=x.origin+x.pathname.split("/").slice(0,-1).join("/")+"/../assets/";var c=D`
i.wb-icon > span.wb-badge {
  font-size: 70%;
  background-color: #486471;
}
div.wunderbaum {
  --wb-active-color-grayscale: #dddddd;
}
div.wunderbaum span.wb-node i.wb-icon {
  background-size: 12px 12px;
  background-position-x: 5px;
  background-position-y: 5px;
}
div.wunderbaum span.wb-node i.wb-expander {
  background-size: 12px 12px;
  background-position-x: 5px;
  background-position-y: 5px;
}`,h={element:null,debugLevel:0,scrollIntoViewOnExpandClick:!1,iconMap:{expanderCollapsed:a+"images/expander.svg",expanderExpanded:a+"images/expanderClose.svg",folder:a+"images/folder.svg",folderLazy:a+"images/folder.svg",folderOpen:a+"images/folder.svg",doc:a+"images/file.svg"},quicksearch:!0,checkbox:!1,source:[],header:!1,iconBadge:l=>{let e=l.node;return e.expanded||!e.children||!e.children.length?null:{badge:e.children.length}}};import F from"wunderbaum/dist/wunderbaum.css"with{type:"css"};var u=class l extends T{_treeDiv;_tree;selectedObject;objectDoubleclicked=new A;static style=k``;static template=N`
      <div id="tree" style="height: 100%; overflow: auto; box-sizing: border-box;" class="wb-skeleton wb-initializing wb-no-select wb-alternate">
      </div>`;constructor(){super(),this._restoreCachedInititalValues(),this.shadowRoot.adoptedStyleSheets=[R(F),c,l.style],this._treeDiv=this._getDomElement("tree"),this.shadowRoot.appendChild(this._treeDiv),this._tree=new H({...h,element:this._treeDiv,iconBadge:null,lazyLoad:e=>new Promise(async t=>{let i=e.node.data.service,n=e.node.data.bindable,r;n?.children?r=n.children:r=await i.getBindableObjects(n,this._instanceServiceContainer),t(r.map(s=>({title:s.name,service:i,bindable:s,lazy:s.children!==!1})))}),dblclick:e=>(this.objectDoubleclicked.emit(),!0),activate:e=>{this.selectedObject=e.node.data.bindable},dnd:{guessDropEffect:!0,preventRecursion:!0,preventVoidMoves:!1,serializeClipboardData:!1,dragStart:e=>(e.event.dataTransfer.effectAllowed="all",e.event.dataTransfer.setData(z,JSON.stringify(e.node.data.bindable)),e.event.dataTransfer.dropEffect="copy",!0),dragEnter:e=>!0}})}_instanceServiceContainer;async initialize(e,t,i){this._instanceServiceContainer=t,this._tree.root.removeChildren();let r=e.bindableObjectsServices;for(let s of r)s.hasObjectsForInstanceServiceContainer(this._instanceServiceContainer,i)&&this._tree.root.addChildren({title:s.name,lazy:!0,service:s})}};customElements.define("node-projects-bindable-objects-browser",u);import{css as M,html as O,BaseCustomWebComponentConstructorAppend as j,cssFromString as L}from"@node-projects/base-custom-webcomponent";import{NamedTools as V,dragDropFormatNameElementDefinition as q}from"@node-projects/web-component-designer";import{Wunderbaum as B}from"wunderbaum";import I from"wunderbaum/dist/wunderbaum.css"with{type:"css"};var g=class l extends j{_treeDiv;_tree;_filter;static style=M`
        :host {
          display: block;
        }

        * {
            touch-action: none;
        }`;static template=O`
      <div style="height: 100%;">
        <input id="input" style="width: 100%; height: 25px; box-sizing: border-box;" placeholder="Filter..." autocomplete="off">
        <div style="height: calc(100% - 26px);">
          <div id="treetable" class="wb-alternate" style="min-width: 100%; box-sizing: border-box;"></div>
        </div>
      </div>`;serviceContainer;constructor(){super(),this._restoreCachedInititalValues(),this.shadowRoot.adoptedStyleSheets=[L(I),c,l.style],this._filter=this._getDomElement("input"),this._filter.onkeyup=()=>{let e=this._filter.value;this._tree.filterNodes(t=>new RegExp(e,"i").test(t.title),{})},this._treeDiv=this._getDomElement("treetable"),this._tree=new B({...h,element:this._treeDiv,filter:{autoExpand:!0,mode:"hide",highlight:!0},click:e=>{if(e.event){let i=e.node.data.ref;if(i){let n=this.serviceContainer.designerTools.get(i.tool??V.DrawElementTool);typeof n=="function"&&(n=new n(i)),this.serviceContainer.globalContext.tool=n}}},dnd:{guessDropEffect:!0,preventRecursion:!0,preventVoidMoves:!1,serializeClipboardData:!1,dragStart:e=>(e.event.dataTransfer.effectAllowed="all",e.event.dataTransfer.setData(q,JSON.stringify(e.node.data.ref)),e.event.dataTransfer.dropEffect="copy",!0),dragEnter:e=>!1}})}async loadControls(e,t){this.serviceContainer=e;let i=this._tree.root;i.removeChildren();for(let n of t){let r=i.addChildren({title:n.name});try{let s=await n.getElements();for(let o of s){let d={title:o.name??o.tag,ref:o};o.icon&&(d.icon=o.icon),r.addChildren(d)}}catch(s){console.warn("Error loading elements",s)}}}};customElements.define("node-projects-palette-tree-view",g);import{css as W,html as P,BaseCustomWebComponentConstructorAppend as K,cssFromString as U}from"@node-projects/base-custom-webcomponent";import{NodeType as v,assetsPath as p,ContextMenu as _,switchContainer as C,DomConverter as J,ForceCssContextMenu as $,hasCommandKey as G}from"@node-projects/web-component-designer";import{Wunderbaum as Q}from"wunderbaum";import X from"wunderbaum/dist/wunderbaum.css"with{type:"css"};var y=Symbol.for("wunderbaumnode"),w=class l extends K{_treeDiv;_tree;_filter;_instanceServiceContainer;_selectionChangedHandler;_contentChangedHandler;static style=W`
      * {
          touch-action: none;
          cursor: default;
      }
    
      .cmd {
        display: flex;
        position: absolute;
        right: 0;
        top: 0;
        height: 100%;
        padding-right: 2px;
        align-items: center;
        gap: 2px;
        background: #ffffffc9;
        width: 42px;
        justify-content: flex-end;
        background: white;
      }
      .cmd > img {
        width: 10px;
      }
      
      div.wunderbaum div.wb-row {
        display: block;
      }
      span.wb-node.wb-col {
        width: unset !important;
        display: inline-block;
      }
      div.wunderbaum span.wb-node span.wb-title {
        text-overflow: unset;
        width: unset !important;
      }
      div.forced {
        border-radius: 50%;
        width: 10px;
        height: 10px;
        background: transparent;
        pointer-events: none;
        top: 5px;
        left: 5px;
        position: relative;
      }
      div.isforced {
        background: orange;
        pointer-events: all;
      }`;static template=P`
      <div style="height: 100%;">
        <input id="input" style="width: 100%; box-sizing: border-box; height:27px;" placeholder="Filter... (regex)" autocomplete="off">
        <div style="height: 18px; border: solid black 1px; padding-left:2px; background: gray;">
          <svg id="expandAll" style="width: 16px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M64 80a16 16 0 0 0-16 16v320a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16V96a16 16 0 0 0-16-16zM0 96a64 64 0 0 1 64-64h320a64 64 0 0 1 64 64v320a64 64 0 0 1-64 64H64a64 64 0 0 1-64-64zm200 248v-64h-64a24 24 0 1 1 0-48h64v-64a24 24 0 1 1 48 0v64h64a24 24 0 1 1 0 48h-64v64a24 24 0 1 1-48 0"></path></svg>
          <svg id="collapseAll" style="width: 16px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M64 80a16 16 0 0 0-16 16v320a16 16 0 0 0 16 16h320a16 16 0 0 0 16-16V96a16 16 0 0 0-16-16zM0 96a64 64 0 0 1 64-64h320a64 64 0 0 1 64 64v320a64 64 0 0 1-64 64H64a64 64 0 0 1-64-64zm152 136h144a24 24 0 1 1 0 48H152a24 24 0 1 1 0-48"></path></svg>
        </div>
        <div style="height: calc(100% - 46px);">
        <div id="treetable" class="wb-alternate" style="min-width: 100%; box-sizing: border-box;"></div>
        </div>
      </div>`;constructor(){super(),this._restoreCachedInititalValues(),this.shadowRoot.adoptedStyleSheets=[U(X),c,l.style],this._filter=this._getDomElement("input"),this._filter.onkeyup=()=>{this._filterNodes()},this._treeDiv=this._getDomElement("treetable"),this._treeDiv.onscroll=()=>{for(let i of this._treeDiv.querySelectorAll(".cmd"))i.style.right="-"+this._treeDiv.scrollLeft+"px"};let e=this._getDomElement("expandAll");e.onclick=()=>{this._tree.root.visit(i=>{i.isExpanded()||i.setExpanded(!0)})};let t=this._getDomElement("collapseAll");t.onclick=()=>{this._tree.root.visit(i=>{i.isExpanded()&&i.setExpanded(!1)})}}_filterNodes(){let e=this._filter.value;if(e){let t=new RegExp(e,"i");this._tree.filterNodes(i=>{let n=i.data.ref;return t.test(n.name)||t.test(n.id)||t.test(n.content)},{})}else this._tree.clearFilter()}_showHideAtDesignTimeState(e,t){t.hideAtDesignTime?e.src=p+"images/treeview/eyeclose.png":e.src=p+"images/treeview/eyeopen.png"}_switchHideAtDesignTimeState(e,t){t.hideAtDesignTime=!t.hideAtDesignTime,this._showHideAtDesignTimeState(e,t)}_showLockAtDesignTimeState(e,t){t.lockAtDesignTime?e.src=p+"images/treeview/lock.png":e.src=p+"images/treeview/dot.png"}_switchLockAtDesignTimeState(e,t){t.lockAtDesignTime=!t.lockAtDesignTime,this._showLockAtDesignTimeState(e,t)}_showHideAtRunTimeState(e,t){t.hideAtRunTime?e.src=p+"images/treeview/eyeclose.png":e.src=p+"images/treeview/eyeopen.png"}_switchHideAtRunTimeState(e,t){t.hideAtRunTime=!t.hideAtRunTime,this._showHideAtRunTimeState(e,t)}showDesignItemContextMenu(e,t){t.preventDefault();let i=[];for(let r of e.serviceContainer.designerContextMenuExtensions)r.shouldProvideContextmenu(t,e.instanceServiceContainer.designerCanvas,e,"treeView")&&i.push(...r.provideContextMenuItems(t,e.instanceServiceContainer.designerCanvas,e,"treeView",this));return _.show(i,t)}selectedFromTree=!1;async ready(){this._tree=new Q({...h,element:this._treeDiv,click:e=>{if(e.event){let n=e.node.data.ref;if(n)if(this.selectedFromTree=!0,setTimeout(()=>{this.selectedFromTree=!1},50),G(e.event)){let r=[...n.instanceServiceContainer.selectionService.selectedElements],s=r.indexOf(n);s>=0?(r.splice(s,1),n.instanceServiceContainer.selectionService.setSelectedElements(r)):n.instanceServiceContainer.selectionService.setSelectedElements([...r,n])}else n.instanceServiceContainer.selectionService.setSelectedElements([n])}return!(e.event.ctrlKey||e.event.shiftKey)},dnd:{guessDropEffect:!0,preventRecursion:!0,preventVoidMoves:!1,serializeClipboardData:!1,dragStart:e=>(e.event.dataTransfer.effectAllowed="all",e.event.dataTransfer.dropEffect="move",!0),dragEnter:e=>(e.event.dataTransfer.dropEffect=e.event.ctrlKey?"copy":"move",!0),dragOver:e=>{e.event.dataTransfer.dropEffect=e.event.ctrlKey?"copy":"move"},drop:async e=>{let t=[e.sourceNode].map(r=>r.data.ref);if(e.event.dataTransfer.dropEffect=="copy"){let r=[];for(let s of t)r.push(await s.clone());t=r}let i=e.node.data.ref,n=i.openGroup("drag/drop in treeview");if(e.region=="over")C(t,i);else if(e.region=="after"||e.region=="before")for(let r of t)r.parent!=i.parent&&C([r],i.parent),e.region=="before"?i.insertAdjacentElement(r,"beforebegin"):i.insertAdjacentElement(r,"afterend");n.commit()}},filter:{autoApply:!0,autoExpand:!0,fuzzy:!0,hideExpanders:!1,highlight:!0,leavesOnly:!1,mode:"hide"},render:e=>{if(e.isNew){let t=e.node,i=e.nodeElem.parentElement,n=t.data.ref;e.nodeElem.oncontextmenu=s=>this.showDesignItemContextMenu(n,s),e.nodeElem.onmouseenter=s=>n.instanceServiceContainer.designerCanvas.showHoverExtension(n.element,s),e.nodeElem.onmouseleave=s=>n.instanceServiceContainer.designerCanvas.showHoverExtension(null,s);let r=document.createElement("span");if(r.style.display="inline-block",r.style.width="42px",e.nodeElem.appendChild(r),n&&n.nodeType===v.Element&&n!==n.instanceServiceContainer.contentService.rootDesignItem){let s=document.createElement("div");s.className="cmd";let o=document.createElement("img");this._showLockAtDesignTimeState(o,n),o.onclick=()=>this._switchLockAtDesignTimeState(o,n),o.title="lock",s.appendChild(o);let d=document.createElement("img");this._showHideAtDesignTimeState(d,n),d.onclick=()=>this._switchHideAtDesignTimeState(d,n),d.title="hide in designer",s.appendChild(d);let m=document.createElement("img");this._showHideAtRunTimeState(m,n),m.onclick=()=>this._switchHideAtRunTimeState(m,n),m.title="hide at runtime",s.appendChild(m),i.appendChild(s);let f=document.createElement("div");f.className="forced",f.title="has forced style",i.appendChild(f),f.addEventListener("click",b=>{let E=new $().provideContextMenuItems(b,n.instanceServiceContainer.designerCanvas,n);new _(E,null).display(b)}),n.hasForcedCss&&(f.className="forced isforced")}}e.nodeElem.querySelector("span.wb-title").innerHTML=e.node.title}})}_recomputeRunning;_recomputeRequestedAgain;async refreshNode(e,t){let n=e.getColElem(0).parentElement.querySelector(".forced");t.hasForcedCss?n.classList.add("isforced"):n.classList.remove("isforced")}async createTree(e){this._tree&&(this._recomputeRunning?this._recomputeRequestedAgain=!0:(this._recomputeRunning=!0,setTimeout(async()=>{this._recomputeRequestedAgain=!1,await this._recomputeTree(e),this._recomputeRunning=!1,this._recomputeRequestedAgain&&(this._recomputeRequestedAgain=!1,this.createTree(e))},20)))}set instanceServiceContainer(e){this._instanceServiceContainer=e,this._selectionChangedHandler?.dispose(),this._instanceServiceContainer?(this._selectionChangedHandler=this._instanceServiceContainer.selectionService.onSelectionChanged.on(t=>{this.selectionChanged(t)}),this._contentChangedHandler?.dispose(),this._contentChangedHandler=this._instanceServiceContainer.contentService.onContentChanged.on(t=>{if(t.changeType==="changed")for(let i of t.designItems)this.refreshNode(i[y],i);else this.createTree(e.contentService.rootDesignItem),setTimeout(()=>{this._highlight(this._instanceServiceContainer.selectionService.selectedElements)},20)}),this.createTree(e.contentService.rootDesignItem)):this._tree.root.removeChildren()}selectionChanged(e){this._highlight(e.selectedElements)}async _recomputeTree(e){try{this._tree.root.removeChildren();let t=this._getChildren(e);this._tree.root.addChildren(t),this._tree.root.visit(i=>{i.data.ref[y]=i}),await this._tree.expandAll(),this._filterNodes()}catch(t){console.error(t)}}_getChildren(e){let t={title:e.isRootItem?"-root-":e.nodeType===v.Element?e.name+" "+(e.id?"#"+e.id:""):"<small><small><small>#"+(e.nodeType===v.TextNode?"text":"comment")+"&nbsp;</small></small></small> "+J.normalizeContentValue(e.content),ref:e};for(let i of e.children())i.isEmptyTextNode||(t.children||(t.children=[]),t.children.push(this._getChildren(i)));return t}_highlight(e){let t=!1;this._tree.runWithDeferredUpdate(()=>{this._tree.visit(i=>{let n=e&&e.includes(i.data.ref);n!=i.selected&&i.setSelected(n),n!=i.isActive()&&i.setActive(n),this.selectedFromTree||(n&&i.setFocus(!0),n&&!t&&(t=!0,requestAnimationFrame(()=>{i.scrollIntoView()})))})})}collapseChildren(e){let t=this._tree.findFirst(i=>e==i.data.ref);t&&t.visit(i=>{i.setExpanded(!1)})}expandChildren(e){let t=this._tree.findFirst(i=>e==i.data.ref);t&&t.visit(i=>{i.setExpanded(!0)})}};customElements.define("node-projects-tree-view-extended",w);var S=class{shouldProvideContextmenu(e,t,i,n){return n=="treeView"}provideContextMenuItems(e,t,i,n,r){return[{title:"collapse children",icon:`<img src="${a+"icons/collapse.svg"}">`,action:()=>{r.collapseChildren(i)}},{title:"expand children",icon:`<img src="${a+"icons/expand.svg"}">`,action:()=>{r.expandChildren(i)}}]}};export{u as BindableObjectsBrowser,S as ExpandCollapseContextMenu,g as PaletteTreeView,w as TreeViewExtended,h as defaultOptions,c as defaultStyle};
